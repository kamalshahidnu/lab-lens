name: Deploy to Google Cloud Run

on:
 push:
  branches:
   - main
  paths:
   - 'model_deployment/**'
   - 'infrastructure/**'
   - 'src/**'
   - 'requirements.txt'
   - '.github/workflows/deploy-cloud-run.yml'
 workflow_dispatch: # Allow manual triggers
  inputs:
   environment:
    description: 'Deployment environment'
    required: true
    default: 'production'
    type: choice
    options:
     - production
     - staging

env:
 PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
 SERVICE_NAME: lab-lens-web
 REGION: us-central1

jobs:
 deploy:
  name: Build and Deploy to Cloud Run
  runs-on: ubuntu-latest
  environment: ${{ github.event.inputs.environment || 'production' }}

  permissions:
   contents: read
   id-token: write

  steps:
   - name: Checkout code
    uses: actions/checkout@v4

   - name: Verify Secrets
    run: |
     if [ -z "${{ secrets.GCP_PROJECT_ID }}" ]; then
      echo " Error: GCP_PROJECT_ID secret is not set"
      exit 1
     fi
     if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
      echo " Error: GCP_SA_KEY secret is not set"
      exit 1
     fi
     echo " Secrets verified"

   - name: Authenticate to Google Cloud
    uses: google-github-actions/auth@v2
    with:
     credentials_json: ${{ secrets.GCP_SA_KEY }}

   - name: Set up Cloud SDK
    uses: google-github-actions/setup-gcloud@v2
    with:
     project_id: ${{ secrets.GCP_PROJECT_ID }}

   - name: Configure Docker auth (gcr.io)
    run: gcloud auth configure-docker gcr.io --quiet

   - name: Build and Push Container (Docker)
    env:
     IMAGE_SHA: gcr.io/${{ secrets.GCP_PROJECT_ID }}/lab-lens-web:${{ github.sha }}
     IMAGE_LATEST: gcr.io/${{ secrets.GCP_PROJECT_ID }}/lab-lens-web:latest
     SKIP_MODEL_DOWNLOAD: "true"
    run: |
     echo "üî® Building container image (Docker)..."
     docker build \
      --build-arg SKIP_MODEL_DOWNLOAD=${SKIP_MODEL_DOWNLOAD} \
      -f infrastructure/docker/Dockerfile.cloudrun \
      -t "${IMAGE_SHA}" \
      -t "${IMAGE_LATEST}" \
      .
     echo "üì§ Pushing images..."
     docker push "${IMAGE_SHA}"
     docker push "${IMAGE_LATEST}"

   - name: Deploy to Cloud Run
    run: |
     echo "üöÄ Deploying to Cloud Run..."
     # Discover the deployed API URL (if present) so the Streamlit frontend can call it.
     API_URL=$(gcloud run services describe lab-lens-api --region $REGION --project $PROJECT_ID --format='value(status.url)' 2>/dev/null || true)
     if [ -n "$API_URL" ]; then
      echo "üîó Using API URL for frontend integration: $API_URL"
     else
      echo "‚ö†Ô∏è Could not resolve lab-lens-api URL; frontend will run in standalone mode"
     fi

     gcloud run deploy $SERVICE_NAME \
      --image gcr.io/$PROJECT_ID/$SERVICE_NAME:${{ github.sha }} \
      --platform managed \
      --region $REGION \
      --allow-unauthenticated \
      --port 8501 \
      --memory 4Gi \
      --cpu 2 \
      --timeout 600 \
      --max-instances 10 \
      --min-instances 0 \
      --set-env-vars HF_HOME=/root/.cache/huggingface,TRANSFORMERS_CACHE=/root/.cache/huggingface,LAB_LENS_API_URL=$API_URL \
      --set-secrets GEMINI_API_KEY=gemini-api-key:latest,GOOGLE_API_KEY=gemini-api-key:latest \
      --project $PROJECT_ID

   - name: Get Service URL
    run: |
     SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region $REGION --format='value(status.url)')
     echo "üöÄ Deployed to: $SERVICE_URL"
     echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT

   - name: Test Health Check
    run: |
     SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region $REGION --format='value(status.url)')
     echo "‚è≥ Waiting for service to be ready..."
     sleep 15
     echo "üîç Testing health endpoint..."
     curl -f $SERVICE_URL/_stcore/health || exit 1
     echo " Health check passed!"

   - name: Comment Deployment URL
    if: github.event_name == 'pull_request'
    uses: actions/github-script@v7
    with:
     script: |
      github.rest.issues.createComment({
       issue_number: context.issue.number,
       owner: context.repo.owner,
       repo: context.repo.repo,
       body: 'üöÄ Deployment successful!\n\nService URL: ${{ steps.deploy.outputs.SERVICE_URL }}'
      })
